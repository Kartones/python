<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Shopping List {{ list_name }}</title>
  </head>
<body role="document">

  <ul class="nav nav-pills justify-content-center navbar bg-light">
    <li class="nav-item">
      <a class="nav-link" href="{{ base_url_path }}">Lists</a>
    </li>
    <li class="nav-item">
      <a class="nav-link active" href="#">Items</a>
    </li>
  </ul>

    <div class="container" style="margin-top: 12px">
        <h3>List: {{ list_name }}</h3>
      <div class="bg-light" style="padding: 6px">
        <a href="?">⬇️ Name</a> <a href="?order_by=state">⬇️ Priority</a>
      </div>
      <div id="items-buttons">
        {% for item in items %}
            <button type="button" class="item btn btn-lg {{ item[2] }}" data-state="{{ item[1] }}"
                data-key="{{ item[0] }}">{{ item[0] }}</button>
        {% endfor %}
      </div>
    </div>

    <footer class="footer">
      <div class="container">
          <input id="newItemName" type="text" placeholder="New item..." />
          <button id="addNewItemButton" type="button" class="btn btn-default"><strong>+</strong></button>
      </div>
    </footer>

    <script type="text/javascript">
      window.timeoutHandler = null;

      function toggleItem(e) {
        const state = parseInt(e.target.dataset.state, 10);

        switch(state) {
          case 0:
              e.target.dataset.state = 1;
              e.target.classList.add("btn-warning");
              e.target.classList.remove("btn-default");
          break;
          case 1:
              e.target.dataset.state = 2;
              e.target.classList.add("btn-danger");
              e.target.classList.remove("btn-warning");
          break;
          case 2:
              e.target.dataset.state = 3;
              e.target.classList.add("btn-dark");
              e.target.classList.remove("btn-danger");
          break;
          case 3:
              e.target.dataset.state = 0;
              e.target.classList.add("btn-default");
              e.target.classList.remove("btn-dark");
          break;
        }

        if (window.timeoutHandler != null) {
          clearTimeout(window.timeoutHandler);
        }
        window.timeoutHandler = setTimeout(applyStateChange, 1000);
      };

      function applyStateChange() {
        clearTimeout(window.timeoutHandler);
        window.timeoutHandler = null;
        saveList();
      };

      function saveList() {
        let items = [];
        document.querySelectorAll("#items-buttons button").forEach(item => {
          const state = parseInt(item.dataset.state, 10);
          if (state !== 3) {
            items.push(item.textContent + " " + state);
          }
        })
        fetch("{{ base_url_path }}items/" + encodeURIComponent("{{ list_name }}"), {
          body: encodeURIComponent(items),
          method: "POST",
          headers: {"Content-type": "application/x-www-form-urlencoded; charset=UTF-8"}
        });
      };

      function addNewItemToList() {
        const newItemName = document.getElementById("newItemName").value.trim().toLowerCase();
        if (newItemName.length > 0 && !itemExists(newItemName)) {
          document.getElementById("items-buttons").insertAdjacentHTML(
            "beforeend", "<button type=\"button\" class=\"item btn btn-lg btn-warning\" data-state=\"1\" data-key=\"" +
            newItemName + "\">" + newItemName + "</button>"
          );

          document.getElementById("newItemName").value = "";
          saveList();
        }
      };

      function itemExists(itemName) {
        return !!document.querySelector("#items-buttons button[data-key=\"" + itemName + "\"]");
      }

      document.getElementById("items-buttons").onclick = function(eventData) {
        if (eventData.target.nodeName === "BUTTON") {
          toggleItem(eventData);
          return false;
        }
        return;
      };

      document.getElementById("addNewItemButton").onclick = addNewItemToList;
    </script>
</body>
</html>